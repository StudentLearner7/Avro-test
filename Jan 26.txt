{
  "size": 0,
  "query": {
    "bool": {
      "must": [
        {
          "wildcard": {
            "value.bpmnProcessId": "Demo*"
          }
        },
        {
          "match": {
            "value.bpmnElementType": "PROCESS"
          }
        }
      ]
    }
  },
  "aggs": {
    "group_by_key": {
      "terms": {
        "field": "key",
        "size": 10000
      },
      "aggs": {
        "custom_processing": {
          "scripted_metric": {
            "init_script": "state.docs = []",
            "map_script": """
              Map docData = new HashMap();
              docData.put('sequence', doc['sequence'].value);
              docData.put('intent', doc['intent'].keyword.value);
              docData.put('source', params['_source']);
              state.docs.add(docData);
            """,
            "combine_script": "return state.docs",
            "reduce_script": """
              Map highestDocs = new HashMap();
              for (state in states) {
                for (doc in state) {
                  if (!highestDocs.containsKey(doc['key']) || 
                      highestDocs.get(doc['key']).get('sequence') < doc.get('sequence')) {
                    if (doc.get('intent').equals('ELEMENT_ACTIVATED')) {
                      highestDocs.put(doc.get('key'), doc);
                    }
                  }
                }
              }
              return highestDocs.values();
            """
          }
        }
      }
    }
  }
}
